{% extends "base.html" %}
{% set active_page = "results" %}

{% block title %}Live Results - upg-strings{% endblock %}
{% block description %}Real-time results from upg-strings ML-guided pipeline.{% endblock %}
{% block og_tags %}
    <meta property="og:title" content="Live Results - upg-strings">
    <meta property="og:description" content="Real-time results from upg-strings ML-guided pipeline.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://compute.upg.gr/results.html">
{% endblock %}

{% block content %}
    <main class="container">
        <section class="section">
            <h1>Live Demo Results</h1>
            <p>Real results from ML-guided Calabi-Yau search. <a href="/" style="margin-left: 1rem;">← Run New Search</a></p>
        </section>

        <div id="loading" style="text-align: center; padding: 3rem;">
            <p style="font-size: 1.125rem;">Loading latest results...</p>
        </div>

        <div id="results-content" style="display: none;">
            <section class="section">
                <h2>Run Metadata</h2>
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <strong>Run Date:</strong>
                        <span id="run-date">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Dataset:</strong>
                        <span id="dataset-name">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Model:</strong>
                        <span id="model-type">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Random Seed:</strong>
                        <span id="random-seed">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Total Candidates:</strong>
                        <span id="total-candidates">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Runtime:</strong>
                        <span id="runtime">-</span>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Performance Metrics</h2>
                <div class="metrics-cards">
                    <div class="metric-card">
                        <div class="metric-value" id="precision-k">-</div>
                        <div class="metric-label">Precision@100</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="recall-k">-</div>
                        <div class="metric-label">Recall@100</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="time-first-hit">-</div>
                        <div class="metric-label">Time to First Hit</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="verified-count">-</div>
                        <div class="metric-label">Verified Targets</div>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Top-20 Results</h2>
                <div class="table-controls">
                    <p>Showing top 20 candidates with highest scores</p>
                </div>
                <div class="table-container">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>h¹¹</th>
                                <th>h²¹</th>
                                <th>χ (Euler)</th>
                                <th>Score</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
{% endblock %}

{% block scripts %}
    <script>
    // Load live results from API
    async function loadResults() {
        try {
            const response = await fetch('/api/sample-results');
            const data = await response.json();

            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';

            // Populate metadata
            const metadata = data.run_metadata;
            document.getElementById('run-date').textContent = metadata.timestamp;
            document.getElementById('dataset-name').textContent = metadata.dataset;
            document.getElementById('model-type').textContent = `${metadata.model_type} (n=${metadata.n_estimators})`;
            document.getElementById('random-seed').textContent = metadata.random_seed;
            document.getElementById('total-candidates').textContent = metadata.total_candidates.toLocaleString();
            document.getElementById('runtime').textContent = data.timing.total_runtime_seconds.toFixed(1) + 's';

            // Populate metrics
            const metrics = data.performance_metrics;
            document.getElementById('precision-k').textContent =
                metrics.precision_at_k ? (metrics.precision_at_k * 100).toFixed(1) + '%' : 'N/A';
            document.getElementById('recall-k').textContent =
                metrics.recall_at_k ? (metrics.recall_at_k * 100).toFixed(1) + '%' : 'N/A';
            document.getElementById('time-first-hit').textContent =
                metrics.time_to_first_hit !== null ? `Rank ${metrics.time_to_first_hit}` : 'N/A';
            document.getElementById('verified-count').textContent =
                `${metrics.verified_count}/${metrics.total_top_k}`;

            // Populate table
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';

            data.top_results.forEach(result => {
                const row = document.createElement('tr');
                const verifiedClass = result.verified_target ? 'verified-true' : 'verified-false';
                const verifiedText = result.verified_target ? '✓ Yes' : '✗ No';

                row.innerHTML = `
                    <td>${result.rank}</td>
                    <td>${result.h11}</td>
                    <td>${result.h21}</td>
                    <td>${result.euler_char}</td>
                    <td>${result.score.toFixed(4)}</td>
                    <td class="${verifiedClass}">${verifiedText}</td>
                `;
                tbody.appendChild(row);
            });

        } catch (error) {
            document.getElementById('loading').innerHTML =
                '<p style="color: #c41e3a;">Error loading results: ' + error.message + '</p>' +
                '<p><a href="/">← Run a new search</a></p>';
        }
    }

    // Load results when page loads
    loadResults();
    </script>
{% endblock %}
