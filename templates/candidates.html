<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidates Gallery - upg-strings</title>
    <meta name="description" content="Top-ranked verified Calabi-Yau candidates with interactive manifold visualizations.">

    <!-- OpenGraph tags -->
    <meta property="og:title" content="Candidates Gallery - upg-strings">
    <meta property="og:description" content="Top-ranked verified Calabi-Yau candidates with interactive manifold visualizations.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://compute.upg.gr/candidates.html">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="nav">
        <div class="container">
            <div class="nav-brand">upg-strings</div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/candidates.html" class="active">Candidates</a>
                <a href="/demo.html">Interactive Demo</a>
                <a href="/docs.html">Docs</a>
                <a href="/results.html">Results</a>
                <a href="/about.html">About</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="section">
            <h1>Top-Ranked Verified Candidates</h1>
            <p>Explore a curated gallery of the highest-ranked manifolds. Click any candidate to view a detailed manifold visualization and topological profile.</p>
            <div class="candidate-controls">
                <div class="control-group">
                    <label for="gallery-dataset">Dataset</label>
                    <select id="gallery-dataset">
                        <option value="kreuzer-skarke" selected>Kreuzer-Skarke (CY 3-folds)</option>
                        <option value="cy5-folds">CY5-Folds (Complete Intersection)</option>
                        <option value="heterotic">Heterotic Compactifications</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="gallery-top-n">Cards</label>
                    <select id="gallery-top-n">
                        <option value="8">8 candidates</option>
                        <option value="12" selected>12 candidates</option>
                        <option value="16">16 candidates</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="gallery-seed">Seed</label>
                    <input type="number" id="gallery-seed" value="42" min="1" max="9999">
                </div>
                <button id="gallery-refresh" class="btn btn-primary">Refresh Gallery</button>
            </div>
            <p id="gallery-description" class="note"></p>
        </section>

        <section class="section">
            <div id="candidates-grid" class="candidates-grid">
                <div class="candidate-card candidate-card-loading">Loading candidates...</div>
            </div>
        </section>
    </main>

    <div id="candidate-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="modal-title">Candidate</h2>
                    <p id="modal-subtitle" class="modal-subtitle"></p>
                </div>
                <button id="modal-close" class="modal-close">Close</button>
            </div>
            <div class="modal-body">
                <div class="modal-meta" id="modal-meta"></div>
                <div class="viz-grid">
                    <div class="viz-panel">
                        <h3>2D Projection</h3>
                        <svg id="manifold-svg" class="viz-svg" viewBox="0 0 320 200" role="img" aria-label="2D manifold projection"></svg>
                    </div>
                    <div class="viz-panel">
                        <h3>3D Fiber Sketch</h3>
                        <canvas id="manifold-canvas" class="viz-canvas"></canvas>
                    </div>
                </div>
                <div class="modal-details">
                    <h3>Topological Profile</h3>
                    <div id="modal-details-content" class="details-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Contact: <a href="mailto:ioannis.kokkinis@upg.gr">ioannis.kokkinis@upg.gr</a> | <a href="https://www.linkedin.com/in/ioanniskokkinis" target="_blank" rel="noopener">LinkedIn</a></p>
            <p class="footer-note">Research tooling for reproducible computational physics experiments</p>
        </div>
    </footer>

    <script>
    const datasetDescriptions = {
        'kreuzer-skarke': 'Searching for manifolds with |chi| < 100.',
        'cy5-folds': 'Searching for manifolds with h11 > 100 (large volume scenarios).',
        'heterotic': 'Searching for balanced manifolds with h11 ~= h21.'
    };

    const grid = document.getElementById('candidates-grid');
    const modal = document.getElementById('candidate-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const modalMeta = document.getElementById('modal-meta');
    const modalDetails = document.getElementById('modal-details-content');
    const svg = document.getElementById('manifold-svg');
    const canvas = document.getElementById('manifold-canvas');
    let animationId = null;

    function mulberry32(a) {
        return function() {
            let t = a += 0x6D2B79F5;
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
    }

    function updateDescription() {
        const datasetId = document.getElementById('gallery-dataset').value;
        document.getElementById('gallery-description').textContent = datasetDescriptions[datasetId] || '';
    }

    function setLoading() {
        grid.innerHTML = '<div class="candidate-card candidate-card-loading">Loading candidates...</div>';
    }

    function renderCandidates(list) {
        if (!list.length) {
            grid.innerHTML = '<div class="candidate-card candidate-card-loading">No candidates available.</div>';
            return;
        }

        grid.innerHTML = list.map(candidate => {
            const featureTags = candidate.features.map(([label, value]) =>
                `<span class="pill">${label}: ${value}</span>`
            ).join('');
            const verifiedText = candidate.verified_target ? 'Verified' : 'Unverified';
            return `
                <div class="candidate-card" data-id="${candidate.candidate_id}" data-dataset="${candidate.dataset_id}" data-seed="${candidate.viz_seed}" data-score="${candidate.score}" data-rank="${candidate.rank}" data-verified="${candidate.verified_target}" data-name="${candidate.dataset_name}">
                    <div class="candidate-rank">#${candidate.rank}</div>
                    <h3 class="candidate-title">${candidate.candidate_id}</h3>
                    <p class="candidate-meta">${candidate.dataset_name}</p>
                    <div class="candidate-score">Score: ${candidate.score.toFixed(4)}</div>
                    <div class="candidate-features">${featureTags}</div>
                    <div class="candidate-tag ${candidate.verified_target ? 'verified' : 'unverified'}">${verifiedText}</div>
                </div>
            `;
        }).join('');
    }

    async function loadCandidates() {
        setLoading();
        const datasetId = document.getElementById('gallery-dataset').value;
        const topN = document.getElementById('gallery-top-n').value;
        const seed = document.getElementById('gallery-seed').value;

        try {
            const response = await fetch(`/api/candidates?dataset_id=${datasetId}&top_n=${topN}&seed=${seed}`);
            const data = await response.json();
            if (data.status !== 'success') {
                throw new Error(data.message || 'Failed to load candidates.');
            }
            renderCandidates(data.candidates || []);
        } catch (error) {
            grid.innerHTML = `<div class="candidate-card candidate-card-loading">Error: ${error.message}</div>`;
        }
    }

    function renderSvg(detail) {
        const seed = detail.viz_seed || 42;
        const rand = mulberry32(seed);
        const loops = 3 + Math.floor(rand() * 3);
        const amplitude = 60 + rand() * 40;
        const path = [];
        const centerX = 160;
        const centerY = 100;

        for (let i = 0; i <= 200; i++) {
            const t = (i / 200) * Math.PI * 2 * loops;
            const r = amplitude * (0.6 + 0.4 * Math.sin(t * 0.6 + rand()));
            const x = centerX + Math.cos(t) * r;
            const y = centerY + Math.sin(t * 1.2) * (r * 0.6);
            path.push(`${i === 0 ? 'M' : 'L'} ${x.toFixed(1)} ${y.toFixed(1)}`);
        }

        svg.innerHTML = `
            <defs>
                <linearGradient id="manifoldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#1a5490"/>
                    <stop offset="100%" stop-color="#4a7ba7"/>
                </linearGradient>
            </defs>
            <rect width="320" height="200" rx="16" fill="#f4f6f8"></rect>
            <path d="${path.join(' ')}" fill="none" stroke="url(#manifoldGradient)" stroke-width="3" stroke-linecap="round"></path>
        `;
    }

    function renderCanvas(detail) {
        if (animationId) {
            cancelAnimationFrame(animationId);
        }

        const ctx = canvas.getContext('2d');
        const seed = detail.viz_seed || 42;
        const rand = mulberry32(seed);
        const width = canvas.clientWidth || 320;
        const height = canvas.clientHeight || 200;
        canvas.width = width;
        canvas.height = height;

        const pointCount = 240;
        const baseRadius = 40 + rand() * 30;
        const points = Array.from({ length: pointCount }, () => {
            const theta = rand() * Math.PI * 2;
            const phi = rand() * Math.PI * 2;
            const radius = baseRadius + rand() * 30;
            return {
                x: radius * Math.cos(theta) * Math.sin(phi),
                y: radius * Math.sin(theta) * Math.sin(phi),
                z: radius * Math.cos(phi)
            };
        });

        let angle = 0;
        const draw = () => {
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#f4f6f8';
            ctx.fillRect(0, 0, width, height);

            const cx = width / 2;
            const cy = height / 2;
            const scale = 1.2;
            const cosA = Math.cos(angle);
            const sinA = Math.sin(angle);

            ctx.strokeStyle = 'rgba(26, 84, 144, 0.6)';
            ctx.lineWidth = 1;

            points.forEach(point => {
                const x = point.x * cosA - point.z * sinA;
                const z = point.x * sinA + point.z * cosA;
                const y = point.y * Math.cos(angle * 0.7) - z * Math.sin(angle * 0.7);
                const depth = (z + 120) / 240;
                const px = cx + x * scale;
                const py = cy + y * scale;
                ctx.beginPath();
                ctx.arc(px, py, 1.2 + depth * 1.8, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(74, 123, 167, ${0.4 + depth * 0.4})`;
                ctx.fill();
            });

            angle += 0.01;
            animationId = requestAnimationFrame(draw);
        };

        draw();
    }

    function openModal(candidate) {
        modal.style.display = 'flex';
        modalTitle.textContent = candidate.candidate_id;
        modalSubtitle.textContent = candidate.dataset_name;
        modalMeta.innerHTML = `
            <span class="pill">Rank #${candidate.rank}</span>
            <span class="pill">Score ${candidate.score.toFixed(4)}</span>
            <span class="pill ${candidate.verified_target ? 'pill-verified' : 'pill-unverified'}">
                ${candidate.verified_target ? 'Verified' : 'Unverified'}
            </span>
        `;
        renderSvg(candidate);
        renderCanvas(candidate);
        modalDetails.innerHTML = '';

        fetch(`/api/candidate/${candidate.candidate_id}?dataset_id=${candidate.dataset_id}`)
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    throw new Error(data.message || 'Unable to load candidate details.');
                }
                const detail = data.candidate;
                const features = detail.features || [];
                const invariants = detail.invariants || [];
                const blocks = [
                    ...features.map(([label, value]) => ({ label, value })),
                    ...invariants
                ];
                modalDetails.innerHTML = blocks.map(item => `
                    <div class="detail-item">
                        <span>${item.label}</span>
                        <strong>${item.value}</strong>
                    </div>
                `).join('');
            })
            .catch(error => {
                modalDetails.innerHTML = `<p class="note">Details unavailable: ${error.message}</p>`;
            });
    }

    function closeModal() {
        modal.style.display = 'none';
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
    }

    document.getElementById('gallery-refresh').addEventListener('click', loadCandidates);
    document.getElementById('gallery-dataset').addEventListener('change', () => {
        updateDescription();
        loadCandidates();
    });

    grid.addEventListener('click', event => {
        const card = event.target.closest('.candidate-card');
        if (!card || card.classList.contains('candidate-card-loading')) return;
        openModal({
            candidate_id: card.dataset.id,
            dataset_id: card.dataset.dataset,
            rank: Number(card.dataset.rank),
            score: Number(card.dataset.score),
            verified_target: card.dataset.verified === 'true',
            dataset_name: card.dataset.name,
            viz_seed: Number(card.dataset.seed)
        });
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    modal.addEventListener('click', event => {
        if (event.target === modal) closeModal();
    });

    updateDescription();
    loadCandidates();
    </script>
</body>
</html>
