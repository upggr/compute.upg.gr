{% extends "base.html" %}
{% set active_page = "results" %}

{% block title %}Run Results - upg-strings{% endblock %}
{% block description %}Results from upg-strings ML-guided pipeline runs.{% endblock %}
{% block og_tags %}
    <meta property="og:title" content="Run Results - upg-strings">
    <meta property="og:description" content="Results from upg-strings ML-guided pipeline runs.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://compute.upg.gr/results.html">
{% endblock %}

{% block content %}
    <main class="container">
        <section class="section">
            <h1>Run Results</h1>
            <p>Real results from ML-guided Calabi-Yau search. <a href="/" style="margin-left: 1rem;">← Run New Search</a></p>
        </section>

        <section class="section" id="share-panel" style="display: none;">
            <h2>Share & Export</h2>
            <div class="share-row">
                <span class="share-label">Shareable run link</span>
                <input id="results-share-link" type="text" readonly>
                <button id="results-copy-share" class="btn btn-secondary">Copy</button>
            </div>
            <div class="export-actions">
                <button id="results-download-json" class="btn btn-secondary">Download JSON</button>
                <button id="results-download-csv" class="btn btn-secondary">Download CSV</button>
                <button id="results-download-cytools" class="btn btn-secondary">CYTools</button>
                <button id="results-download-cymetric" class="btn btn-secondary">cymetric</button>
                <button id="results-download-sage" class="btn btn-secondary">Sage</button>
                <button id="results-download-math" class="btn btn-secondary">Mathematica</button>
            </div>
        </section>

        <div id="loading" style="text-align: center; padding: 3rem;">
            <p style="font-size: 1.125rem;">Loading latest results...</p>
        </div>

        <div id="results-content" style="display: none;">
            <section class="section">
                <h2>Run Metadata</h2>
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <strong>Run Date:</strong>
                        <span id="run-date">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Dataset:</strong>
                        <span id="dataset-name">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Model:</strong>
                        <span id="model-type">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Random Seed:</strong>
                        <span id="random-seed">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Total Candidates:</strong>
                        <span id="total-candidates">-</span>
                    </div>
                    <div class="metadata-item">
                        <strong>Runtime:</strong>
                        <span id="runtime">-</span>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Performance Metrics</h2>
                <div class="metrics-cards">
                    <div class="metric-card">
                        <div class="metric-value" id="precision-k">-</div>
                        <div class="metric-label">Precision@100</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="recall-k">-</div>
                        <div class="metric-label">Recall@100</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="time-first-hit">-</div>
                        <div class="metric-label">Time to First Hit</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="verified-count">-</div>
                        <div class="metric-label">Verified Targets</div>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Top-20 Results</h2>
                <div class="table-controls">
                    <p>Showing top 20 candidates with highest scores</p>
                </div>
                <div class="table-container">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>h¹¹</th>
                                <th>h²¹</th>
                                <th>χ (Euler)</th>
                                <th>Score</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="result-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2 id="result-modal-title">Candidate</h2>
                        <p id="result-modal-subtitle" class="modal-subtitle"></p>
                    </div>
                    <button id="result-modal-close" class="modal-close">Close</button>
                </div>
                <div class="modal-body">
                    <div class="modal-meta" id="result-modal-meta"></div>
                    <div class="viz-grid">
                        <div class="viz-panel">
                            <h3>2D Projection</h3>
                            <svg id="result-svg" class="viz-svg" viewBox="0 0 320 200" role="img" aria-label="2D manifold projection"></svg>
                        </div>
                        <div class="viz-panel">
                            <h3>3D Fiber Sketch</h3>
                            <canvas id="result-canvas" class="viz-canvas"></canvas>
                        </div>
                        <div class="viz-panel">
                            <h3>3D Field</h3>
                            <canvas id="result-field" class="viz-canvas"></canvas>
                        </div>
                    </div>
                    <div class="modal-details">
                        <h3>Topological Profile</h3>
                        <div id="result-details" class="details-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block scripts %}
    <script>
    // Load live results from API
    let activeRunId = null;

    function updateSharePanel(runId) {
        const panel = document.getElementById('share-panel');
        if (!runId) {
            panel.style.display = 'none';
            return;
        }
        activeRunId = runId;
        panel.style.display = 'block';
        document.getElementById('results-share-link').value = `${window.location.origin}/results.html?run_id=${runId}`;
    }

    const modal = document.getElementById('result-modal');
    const modalTitle = document.getElementById('result-modal-title');
    const modalSubtitle = document.getElementById('result-modal-subtitle');
    const modalMeta = document.getElementById('result-modal-meta');
    const modalDetails = document.getElementById('result-details');
    const svg = document.getElementById('result-svg');
    const canvas = document.getElementById('result-canvas');
    const fieldCanvas = document.getElementById('result-field');
    let animationId = null;
    let fieldAnimationId = null;

    function mulberry32(a) {
        return function() {
            let t = a += 0x6D2B79F5;
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
    }

    function getThemeColors() {
        const styles = getComputedStyle(document.documentElement);
        return {
            primary: styles.getPropertyValue('--primary-color').trim() || '#1a5490',
            secondary: styles.getPropertyValue('--secondary-color').trim() || '#4a7ba7',
            bg: styles.getPropertyValue('--bg-secondary').trim() || '#f4f6f8'
        };
    }

    function hexToRgb(hex) {
        const cleaned = hex.replace('#', '');
        if (cleaned.length !== 6) return { r: 26, g: 84, b: 144 };
        return {
            r: parseInt(cleaned.slice(0, 2), 16),
            g: parseInt(cleaned.slice(2, 4), 16),
            b: parseInt(cleaned.slice(4, 6), 16)
        };
    }

    function colorToRgba(hex, alpha) {
        const { r, g, b } = hexToRgb(hex);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function renderSvg(seed) {
        const rand = mulberry32(seed);
        const colors = getThemeColors();
        const loops = 3 + Math.floor(rand() * 3);
        const amplitude = 60 + rand() * 40;
        const path = [];
        const centerX = 160;
        const centerY = 100;

        for (let i = 0; i <= 200; i++) {
            const t = (i / 200) * Math.PI * 2 * loops;
            const r = amplitude * (0.6 + 0.4 * Math.sin(t * 0.6 + rand()));
            const x = centerX + Math.cos(t) * r;
            const y = centerY + Math.sin(t * 1.2) * (r * 0.6);
            path.push(`${i === 0 ? 'M' : 'L'} ${x.toFixed(1)} ${y.toFixed(1)}`);
        }

        svg.innerHTML = `
            <defs>
                <linearGradient id="resultGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="${colors.primary}"/>
                    <stop offset="100%" stop-color="${colors.secondary}"/>
                </linearGradient>
            </defs>
            <rect width="320" height="200" rx="16" fill="${colors.bg}"></rect>
            <path d="${path.join(' ')}" fill="none" stroke="url(#resultGradient)" stroke-width="3" stroke-linecap="round"></path>
        `;
    }

    function renderCanvas(seed) {
        if (animationId) {
            cancelAnimationFrame(animationId);
        }

        const ctx = canvas.getContext('2d');
        const rand = mulberry32(seed);
        const colors = getThemeColors();
        const width = canvas.clientWidth || 320;
        const height = canvas.clientHeight || 200;
        canvas.width = width;
        canvas.height = height;

        const pointCount = 240;
        const baseRadius = 40 + rand() * 30;
        const points = Array.from({ length: pointCount }, () => {
            const theta = rand() * Math.PI * 2;
            const phi = rand() * Math.PI * 2;
            const radius = baseRadius + rand() * 30;
            return {
                x: radius * Math.cos(theta) * Math.sin(phi),
                y: radius * Math.sin(theta) * Math.sin(phi),
                z: radius * Math.cos(phi)
            };
        });

        let angle = 0;
        const draw = () => {
            ctx.clearRect(0, 0, width, height);
            const bgGrad = ctx.createLinearGradient(0, 0, width, height);
            bgGrad.addColorStop(0, colors.bg);
            bgGrad.addColorStop(1, colorToRgba(colors.secondary, 0.08));
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, width, height);

            const cx = width / 2;
            const cy = height / 2;
            const scale = 1.2;
            const cosA = Math.cos(angle);
            const sinA = Math.sin(angle);

            points.forEach(point => {
                const x = point.x * cosA - point.z * sinA;
                const z = point.x * sinA + point.z * cosA;
                const y = point.y * Math.cos(angle * 0.7) - z * Math.sin(angle * 0.7);
                const depth = (z + 120) / 240;
                const px = cx + x * scale;
                const py = cy + y * scale;
                ctx.beginPath();
                ctx.arc(px, py, 1.2 + depth * 1.8, 0, Math.PI * 2);
                ctx.fillStyle = colorToRgba(colors.secondary, 0.28 + depth * 0.5);
                ctx.fill();
            });

            angle += 0.01;
            animationId = requestAnimationFrame(draw);
        };

        draw();
    }

    function renderFieldCanvas(seed) {
        if (fieldAnimationId) {
            cancelAnimationFrame(fieldAnimationId);
        }

        const ctx = fieldCanvas.getContext('2d');
        const rand = mulberry32(seed + 99);
        const colors = getThemeColors();
        const width = fieldCanvas.clientWidth || 320;
        const height = fieldCanvas.clientHeight || 200;
        fieldCanvas.width = width;
        fieldCanvas.height = height;

        const ribbons = Array.from({ length: 6 }, () => ({
            offset: rand() * Math.PI * 2,
            speed: 0.4 + rand() * 0.6,
            amplitude: 20 + rand() * 25
        }));

        let t = 0;
        const draw = () => {
            ctx.clearRect(0, 0, width, height);
            const bgGrad = ctx.createLinearGradient(0, 0, width, height);
            bgGrad.addColorStop(0, colors.bg);
            bgGrad.addColorStop(1, colorToRgba(colors.primary, 0.08));
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, width, height);

            ribbons.forEach((ribbon, idx) => {
                ctx.beginPath();
                for (let x = 0; x <= width; x += 6) {
                    const phase = ribbon.offset + t * ribbon.speed + x * 0.01;
                    const y = height / 2 + Math.sin(phase) * ribbon.amplitude + Math.sin(phase * 0.7) * 12;
                    if (x === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                const alpha = 0.22 + idx * 0.1;
                ctx.strokeStyle = colorToRgba(colors.primary, alpha);
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            t += 0.02;
            fieldAnimationId = requestAnimationFrame(draw);
        };

        draw();
    }

    function openModal(result, datasetName) {
        const seed = (result.rank || 1) * 1357;
        modal.style.display = 'flex';
        modalTitle.textContent = `Rank #${result.rank}`;
        modalSubtitle.textContent = datasetName || 'Candidate details';
        modalMeta.innerHTML = `
            <span class="pill">Score ${result.score.toFixed(4)}</span>
            <span class="pill ${result.verified_target ? 'pill-verified' : 'pill-unverified'}">
                ${result.verified_target ? 'Verified' : 'Unverified'}
            </span>
        `;

        const detailItems = [];
        Object.entries(result).forEach(([key, value]) => {
            if (key === 'score' || key === 'verified_target') return;
            detailItems.push(`<div class="detail-item"><span>${key}</span><strong>${value}</strong></div>`);
        });
        modalDetails.innerHTML = detailItems.join('');

        renderSvg(seed);
        renderCanvas(seed);
        renderFieldCanvas(seed);
    }

    function closeModal() {
        modal.style.display = 'none';
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (fieldAnimationId) {
            cancelAnimationFrame(fieldAnimationId);
            fieldAnimationId = null;
        }
    }

    async function loadResults() {
        try {
            const params = new URLSearchParams(window.location.search);
            const runId = params.get('run_id');
            const endpoint = runId ? `/api/results/${runId}` : '/api/sample-results';
            const response = await fetch(endpoint);
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';
            updateSharePanel(runId);

            // Populate metadata
            const metadata = data.run_metadata;
            document.getElementById('run-date').textContent = metadata.timestamp;
            document.getElementById('dataset-name').textContent = metadata.dataset;
            document.getElementById('model-type').textContent = `${metadata.model_type} (n=${metadata.n_estimators})`;
            document.getElementById('random-seed').textContent = metadata.random_seed;
            document.getElementById('total-candidates').textContent = metadata.total_candidates.toLocaleString();
            document.getElementById('runtime').textContent = data.timing.total_runtime_seconds.toFixed(1) + 's';

            // Populate metrics
            const metrics = data.performance_metrics;
            document.getElementById('precision-k').textContent =
                metrics.precision_at_k ? (metrics.precision_at_k * 100).toFixed(1) + '%' : 'N/A';
            document.getElementById('recall-k').textContent =
                metrics.recall_at_k ? (metrics.recall_at_k * 100).toFixed(1) + '%' : 'N/A';
            document.getElementById('time-first-hit').textContent =
                metrics.time_to_first_hit !== null ? `Rank ${metrics.time_to_first_hit}` : 'N/A';
            document.getElementById('verified-count').textContent =
                `${metrics.verified_count}/${metrics.total_top_k}`;

            // Populate table
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';

            data.top_results.forEach(result => {
                const row = document.createElement('tr');
                const verifiedClass = result.verified_target ? 'verified-true' : 'verified-false';
                const verifiedText = result.verified_target ? '✓ Yes' : '✗ No';

                row.innerHTML = `
                    <td>${result.rank}</td>
                    <td>${result.h11}</td>
                    <td>${result.h21}</td>
                    <td>${result.euler_char}</td>
                    <td>${result.score.toFixed(4)}</td>
                    <td class="${verifiedClass}">${verifiedText}</td>
                `;
                row.addEventListener('click', () => {
                    openModal(result, data.run_metadata.dataset);
                });
                tbody.appendChild(row);
            });

        } catch (error) {
            document.getElementById('loading').innerHTML =
                '<p style="color: #c41e3a;">Error loading results: ' + error.message + '</p>' +
                '<p><a href="/">← Run a new search</a></p>';
        }
    }

    // Load results when page loads
    loadResults();

    document.getElementById('result-modal-close').addEventListener('click', closeModal);
    modal.addEventListener('click', event => {
        if (event.target === modal) closeModal();
    });

    function downloadExport(format, filename) {
        if (!activeRunId) return;
        fetch(`/api/export/${activeRunId}?format=${format}`)
            .then(response => Promise.all([response.text(), response.headers.get('Content-Type')]))
            .then(([content, contentType]) => {
                const blob = new Blob([content], { type: contentType || 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
    }

    document.getElementById('results-download-json').addEventListener('click', () => {
        downloadExport('json', `results_${activeRunId || 'run'}.json`);
    });
    document.getElementById('results-download-csv').addEventListener('click', () => {
        downloadExport('csv', `results_${activeRunId || 'run'}.csv`);
    });
    document.getElementById('results-download-cytools').addEventListener('click', () => {
        downloadExport('cytools', `cytools_${activeRunId || 'run'}.json`);
    });
    document.getElementById('results-download-cymetric').addEventListener('click', () => {
        downloadExport('cymetric', `cymetric_${activeRunId || 'run'}.json`);
    });
    document.getElementById('results-download-sage').addEventListener('click', () => {
        downloadExport('sage', `candidates_${activeRunId || 'run'}.sage`);
    });
    document.getElementById('results-download-math').addEventListener('click', () => {
        downloadExport('mathematica', `candidates_${activeRunId || 'run'}.wl`);
    });

    document.getElementById('results-copy-share').addEventListener('click', async function() {
        const input = document.getElementById('results-share-link');
        if (!input.value) return;
        try {
            await navigator.clipboard.writeText(input.value);
            this.textContent = 'Copied!';
            setTimeout(() => {
                this.textContent = 'Copy';
            }, 1500);
        } catch (error) {
            input.select();
            document.execCommand('copy');
        }
    });
    </script>
{% endblock %}
