<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Demo - upg-strings</title>
    <meta name="description" content="Interactive demo with customizable parameters and run history.">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="nav">
        <div class="container">
            <div class="nav-brand">upg-strings</div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/candidates.html">Candidates</a>
                <a href="/demo.html" class="active">Interactive Demo</a>
                <a href="/docs.html">Docs</a>
                <a href="/results.html">Results</a>
                <a href="/about.html">About</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="section">
            <h1>Interactive Demo</h1>
            <p>Customize search parameters and run live ML-guided searches. All runs are saved to history for comparison.</p>
        </section>

        <section class="section">
            <h2>Search Parameters</h2>
            <div style="background: var(--bg-secondary); padding: 2rem; border-radius: 8px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <label for="dataset_id" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Dataset</label>
                        <select id="dataset_id" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                            <option value="kreuzer-skarke" selected>Kreuzer-Skarke (CY 3-folds)</option>
                            <option value="cy5-folds">CY5-Folds (Complete Intersection)</option>
                            <option value="heterotic">Heterotic Compactifications</option>
                        </select>
                        <p id="dataset-description" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Searching for manifolds with |Ï‡| < 100
                        </p>
                    </div>

                    <div>
                        <label for="n_candidates" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Dataset Size</label>
                        <select id="n_candidates" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                            <option value="1000">1,000 candidates (fast, ~2s)</option>
                            <option value="5000" selected>5,000 candidates (recommended, ~5s)</option>
                            <option value="10000">10,000 candidates (thorough, ~10s)</option>
                            <option value="25000">25,000 candidates (comprehensive, ~30s)</option>
                        </select>
                    </div>

                    <div>
                        <label for="top_k" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Top-K Results</label>
                        <select id="top_k" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                            <option value="20">Top 20</option>
                            <option value="50">Top 50</option>
                            <option value="100" selected>Top 100</option>
                            <option value="200">Top 200</option>
                        </select>
                    </div>

                    <div>
                        <label for="seed" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Random Seed</label>
                        <input type="number" id="seed" value="42" min="1" max="9999" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>

                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Verification</label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;">
                            <input type="checkbox" id="verify" checked style="width: 20px; height: 20px;">
                            <span>Verify against ground truth</span>
                        </label>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button id="run-search-btn" class="btn btn-primary" style="font-size: 1.125rem; padding: 1rem 3rem;">
                        ðŸš€ Run Search
                    </button>
                </div>
            </div>

            <div id="search-status" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f0f7ff; border-left: 4px solid var(--primary-color); border-radius: 4px;">
                <p id="status-text" style="margin: 0; font-weight: 500;"></p>
                <div id="progress-bar" style="margin-top: 0.5rem; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                    <div id="progress-fill" style="height: 100%; width: 0%; background: var(--primary-color); transition: width 0.3s;"></div>
                </div>
            </div>
        </section>

        <section class="section" id="current-results" style="display: none;">
            <h2>Current Run Results</h2>
            <p id="current-run-label" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
            <div class="metrics-cards">
                <div class="metric-card">
                    <div class="metric-value" id="current-precision">-</div>
                    <div class="metric-label">Precision@K</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="current-recall">-</div>
                    <div class="metric-label">Recall@K</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="current-runtime">-</div>
                    <div class="metric-label">Runtime</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="current-verified">-</div>
                    <div class="metric-label">Verified</div>
                </div>
            </div>
            <div style="margin-top: 1.5rem; text-align: center;">
                <button id="download-json" class="btn btn-secondary">Download Results JSON</button>
                <button id="download-csv" class="btn btn-secondary" style="margin-left: 0.75rem;">Download Top Results CSV</button>
            </div>
        </section>

        <section class="section">
            <h2>Bring Your Own Data</h2>
            <p>Paste CSV rows matching the selected dataset's feature columns and score them with the trained model.</p>
            <div style="background: var(--bg-secondary); padding: 2rem; border-radius: 8px;">
                <p id="custom-columns" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;"></p>
                <textarea id="custom-data" rows="6" placeholder="Example:&#10;12, 45, 66, 3.75, 924&#10;18, 20, 4, 1.12, 430" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-family: var(--font-mono);"></textarea>
                <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                    <label style="font-weight: 600;">Load CSV file</label>
                    <input type="file" id="custom-file" accept=".csv,text/csv">
                    <label for="custom-top-k" style="font-weight: 600;">Top-K</label>
                    <input type="number" id="custom-top-k" value="20" min="1" max="200" style="width: 100px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                    <button id="run-custom-btn" class="btn btn-primary">Score Custom Data</button>
                </div>
                <p id="custom-error" style="color: #c41e3a; margin-top: 0.75rem; display: none;"></p>
            </div>
        </section>

        <section class="section">
            <h2>Run History</h2>
            <p>All searches are automatically saved. Click any row to view full results.</p>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Candidates</th>
                            <th>Top-K</th>
                            <th>Precision</th>
                            <th>Recall</th>
                            <th>Runtime</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                No runs yet. Start a search above to see history.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>Contact: <a href="mailto:ioannis.kokkinis@upg.gr">ioannis.kokkinis@upg.gr</a> | <a href="https://www.linkedin.com/in/ioanniskokkinis" target="_blank" rel="noopener">LinkedIn</a></p>
            <p class="footer-note">Research tooling for reproducible computational physics experiments</p>
        </div>
    </footer>

    <div id="history-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-narrow">
            <div class="modal-header">
                <div>
                    <h2>Run Details</h2>
                    <p id="history-subtitle" class="modal-subtitle"></p>
                </div>
                <button id="history-close" class="modal-close">Close</button>
            </div>
            <div class="modal-body">
                <div id="history-details" class="details-grid"></div>
            </div>
        </div>
    </div>

    <script>
    // Dataset descriptions
    const datasetDescriptions = {
        'kreuzer-skarke': 'Searching for manifolds with |Ï‡| < 100',
        'cy5-folds': 'Searching for manifolds with h^{1,1} > 100',
        'heterotic': 'Searching for balanced manifolds with h^{1,1} â‰ˆ h^{2,1}'
    };

    const featureColumns = {
        'kreuzer-skarke': ['h11', 'h21', 'euler_abs', 'hodge_ratio', 'c2_h11'],
        'cy5-folds': ['h11', 'h21', 'h31', 'euler', 'euler_abs', 'hodge_sum'],
        'heterotic': ['h11', 'h21', 'euler', 'euler_abs', 'hodge_ratio', 'hodge_balance', 'n_gen']
    };

    let latestResults = null;

    function updateCustomColumns() {
        const datasetId = document.getElementById('dataset_id').value;
        const cols = featureColumns[datasetId] || [];
        const text = cols.length ? `Expected columns: ${cols.join(', ')}` : '';
        document.getElementById('custom-columns').textContent = text;
    }

    // Update description when dataset changes
    document.getElementById('dataset_id').addEventListener('change', function() {
        const desc = datasetDescriptions[this.value] || '';
        document.getElementById('dataset-description').textContent = desc;
        updateCustomColumns();
    });

    // Load history from localStorage
    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('cy_search_history') || '[]');
        const tbody = document.getElementById('history-tbody');

        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No runs yet. Start a search above to see history.</td></tr>';
            return;
        }

        tbody.innerHTML = history.map(run => `
            <tr style="cursor: pointer;" onclick="viewRun('${run.run_id}')">
                <td>${new Date(run.timestamp).toLocaleString()}</td>
                <td>${run.n_candidates.toLocaleString()}</td>
                <td>${run.top_k}</td>
                <td>${(run.precision * 100).toFixed(1)}%</td>
                <td>${(run.recall * 100).toFixed(1)}%</td>
                <td>${run.runtime.toFixed(1)}s</td>
            </tr>
        `).join('');
    }

    function saveToHistory(runData) {
        const history = JSON.parse(localStorage.getItem('cy_search_history') || '[]');
        history.unshift(runData);  // Add to beginning
        if (history.length > 50) history.pop();  // Keep last 50
        localStorage.setItem('cy_search_history', JSON.stringify(history));
        loadHistory();
    }

    function viewRun(runId) {
        const history = JSON.parse(localStorage.getItem('cy_search_history') || '[]');
        const run = history.find(item => item.run_id === runId);
        const details = document.getElementById('history-details');
        const subtitle = document.getElementById('history-subtitle');

        if (!run) {
            subtitle.textContent = 'Run not found in local history.';
            details.innerHTML = '';
        } else {
            subtitle.textContent = `Run ID: ${run.run_id}`;
            details.innerHTML = `
                <div class="detail-item"><span>Timestamp</span><strong>${new Date(run.timestamp).toLocaleString()}</strong></div>
                <div class="detail-item"><span>Dataset size</span><strong>${run.n_candidates.toLocaleString()}</strong></div>
                <div class="detail-item"><span>Top-K</span><strong>${run.top_k}</strong></div>
                <div class="detail-item"><span>Precision</span><strong>${(run.precision * 100).toFixed(1)}%</strong></div>
                <div class="detail-item"><span>Recall</span><strong>${(run.recall * 100).toFixed(1)}%</strong></div>
                <div class="detail-item"><span>Runtime</span><strong>${run.runtime.toFixed(1)}s</strong></div>
            `;
        }

        document.getElementById('history-modal').style.display = 'flex';
    }

    function showResults(results, label) {
        const metrics = results.performance_metrics;
        const timing = results.timing || { total_runtime_seconds: 0 };

        document.getElementById('current-precision').textContent =
            metrics.precision_at_k ? (metrics.precision_at_k * 100).toFixed(1) + '%' : 'N/A';
        document.getElementById('current-recall').textContent =
            metrics.recall_at_k ? (metrics.recall_at_k * 100).toFixed(1) + '%' : 'N/A';
        document.getElementById('current-runtime').textContent =
            timing.total_runtime_seconds !== undefined ? timing.total_runtime_seconds.toFixed(1) + 's' : 'N/A';
        document.getElementById('current-verified').textContent =
            `${metrics.verified_count}/${metrics.total_top_k}`;
        document.getElementById('current-run-label').textContent = label;

        latestResults = results;
        document.getElementById('current-results').style.display = 'block';
    }

    function downloadFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }

    function toCsv(data) {
        if (!data || data.length === 0) return '';
        const headers = Object.keys(data[0]);
        const escapeValue = value => {
            const str = value === null || value === undefined ? '' : String(value);
            return `"${str.replace(/"/g, '""')}"`;
        };
        const rows = data.map(row => headers.map(key => escapeValue(row[key])).join(','));
        return [headers.join(','), ...rows].join('\n');
    }

    // Run search
    document.getElementById('run-search-btn').addEventListener('click', async function() {
        const btn = this;
        const statusDiv = document.getElementById('search-status');
        const statusText = document.getElementById('status-text');
        const progressFill = document.getElementById('progress-fill');
        const resultsSection = document.getElementById('current-results');

        // Get parameters
        const params = {
            dataset_id: document.getElementById('dataset_id').value,
            n_candidates: parseInt(document.getElementById('n_candidates').value),
            top_k: parseInt(document.getElementById('top_k').value),
            seed: parseInt(document.getElementById('seed').value),
            verify: document.getElementById('verify').checked,
            use_real: true
        };

        // UI updates
        btn.disabled = true;
        btn.textContent = 'â³ Running...';
        statusDiv.style.display = 'block';
        resultsSection.style.display = 'none';
        statusText.textContent = `Searching ${params.n_candidates.toLocaleString()} Calabi-Yau manifolds...`;
        progressFill.style.width = '30%';

        try {
            const response = await fetch('/api/run-demo', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(params)
            });

            const data = await response.json();
            progressFill.style.width = '100%';

            if (data.status === 'success') {
                showResults(data.results, `Run type: demo search (${params.dataset_id})`);
                statusDiv.style.display = 'none';

                // Save to history
                saveToHistory({
                    run_id: data.run_id,
                    timestamp: new Date().toISOString(),
                    n_candidates: params.n_candidates,
                    top_k: params.top_k,
                    precision: metrics.precision_at_k || 0,
                    recall: metrics.recall_at_k || 0,
                    runtime: timing.total_runtime_seconds
                });

                btn.textContent = 'âœ“ Search Complete!';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'ðŸš€ Run Search';
                }, 2000);
            } else {
                statusText.textContent = 'Error: ' + (data.message || 'Unknown error');
                btn.disabled = false;
                btn.textContent = 'ðŸš€ Run Search';
            }
        } catch (error) {
            statusText.textContent = 'Error: ' + error.message;
            btn.disabled = false;
            btn.textContent = 'ðŸš€ Run Search';
        }
    });

    // Custom data scoring
    document.getElementById('run-custom-btn').addEventListener('click', async function() {
        const errorEl = document.getElementById('custom-error');
        errorEl.style.display = 'none';

        const datasetId = document.getElementById('dataset_id').value;
        const expectedCount = (featureColumns[datasetId] || []).length;
        const raw = document.getElementById('custom-data').value.trim();

        if (!raw) {
            errorEl.textContent = 'Please paste CSV rows before scoring.';
            errorEl.style.display = 'block';
            return;
        }

        let rows = [];
        try {
            raw.split(/\r?\n/).forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                const parts = trimmed.split(/[\s,]+/).filter(Boolean);
                if (parts.length !== expectedCount) {
                    throw new Error(`Each row must have ${expectedCount} values.`);
                }
                rows.push(parts.map(val => {
                    const num = Number(val);
                    if (Number.isNaN(num)) {
                        throw new Error('All values must be numeric.');
                    }
                    return num;
                }));
            });
        } catch (err) {
            errorEl.textContent = err.message;
            errorEl.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('/api/score-custom', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    dataset_id: datasetId,
                    rows,
                    top_k: parseInt(document.getElementById('custom-top-k').value, 10) || 20,
                    seed: parseInt(document.getElementById('seed').value, 10) || 42,
                    verify: document.getElementById('verify').checked
                })
            });

            const data = await response.json();
            if (data.status === 'success') {
                showResults(data.results, `Run type: custom input (${datasetId})`);
            } else {
                errorEl.textContent = data.message || 'Failed to score custom data.';
                errorEl.style.display = 'block';
            }
        } catch (error) {
            errorEl.textContent = error.message;
            errorEl.style.display = 'block';
        }
    });

    // File loader for custom CSV
    document.getElementById('custom-file').addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = event => {
            document.getElementById('custom-data').value = event.target.result || '';
        };
        reader.readAsText(file);
    });

    // Download actions
    document.getElementById('download-json').addEventListener('click', function() {
        if (!latestResults) return;
        downloadFile('results.json', JSON.stringify(latestResults, null, 2), 'application/json');
    });

    document.getElementById('download-csv').addEventListener('click', function() {
        if (!latestResults) return;
        const csv = toCsv(latestResults.top_results || []);
        downloadFile('results_top.csv', csv, 'text/csv');
    });

    // Load history on page load
    loadHistory();
    updateCustomColumns();
    document.getElementById('history-close').addEventListener('click', () => {
        document.getElementById('history-modal').style.display = 'none';
    });
    document.getElementById('history-modal').addEventListener('click', event => {
        if (event.target.id === 'history-modal') {
            document.getElementById('history-modal').style.display = 'none';
        }
    });
    </script>
</body>
</html>
