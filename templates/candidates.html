{% extends "base.html" %}
{% set active_page = "candidates" %}

{% block title %}Candidates Gallery - upg-strings{% endblock %}
{% block description %}Top-ranked verified Calabi-Yau candidates with interactive manifold visualizations.{% endblock %}
{% block og_tags %}
    <meta property="og:title" content="Candidates Gallery - upg-strings">
    <meta property="og:description" content="Top-ranked verified Calabi-Yau candidates with interactive manifold visualizations.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://compute.upg.gr/candidates.html">
{% endblock %}

{% block content %}
    <main class="container">
        <section class="section">
            <h1>Top-Ranked Verified Candidates</h1>
            <p>Explore a curated gallery of the highest-ranked manifolds. Click any candidate to view a detailed manifold visualization and topological profile.</p>
            <div class="candidate-controls">
                <div class="control-group">
                    <label for="gallery-view">View</label>
                    <select id="gallery-view">
                        <option value="featured" selected>Featured</option>
                        <option value="live">Live Results</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="gallery-dataset">Dataset</label>
                    <select id="gallery-dataset">
                        <option value="kreuzer-skarke" selected>Kreuzer-Skarke (CY 3-folds)</option>
                        <option value="cy5-folds">CY5-Folds (Complete Intersection)</option>
                        <option value="heterotic">Heterotic Compactifications</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="gallery-top-n">Cards</label>
                    <select id="gallery-top-n">
                        <option value="8">8 candidates</option>
                        <option value="12" selected>12 candidates</option>
                        <option value="16">16 candidates</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="gallery-seed">Seed</label>
                    <input type="number" id="gallery-seed" value="42" min="1" max="9999">
                </div>
                <div class="control-group">
                    <label for="gallery-verified">Verified</label>
                    <select id="gallery-verified">
                        <option value="all" selected>All</option>
                        <option value="true">Verified only</option>
                        <option value="false">Unverified only</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="select-mode">Select</label>
                    <label class="select-toggle">
                        <input type="checkbox" id="select-mode">
                        <span>Enable export</span>
                    </label>
                </div>
                <button id="gallery-refresh" class="btn btn-primary">Refresh Gallery</button>
                <button id="gallery-export" class="btn btn-secondary" disabled>Export Selected</button>
            </div>
            <div id="tag-filters" class="tag-filters"></div>
            <p id="selection-count" class="note"></p>
            <p id="gallery-description" class="note"></p>
        </section>

        <section class="section">
            <div id="candidates-grid" class="candidates-grid">
                <div class="candidate-card candidate-card-loading">Loading candidates...</div>
            </div>
        </section>

        <div id="candidate-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h2 id="modal-title">Candidate</h2>
                        <p id="modal-subtitle" class="modal-subtitle"></p>
                    </div>
                    <button id="modal-close" class="modal-close">Close</button>
                </div>
                <div class="modal-body">
                    <div class="modal-meta" id="modal-meta"></div>
                    <div class="viz-grid">
                        <div class="viz-panel">
                            <h3>2D Projection</h3>
                            <svg id="manifold-svg" class="viz-svg" viewBox="0 0 320 200" role="img" aria-label="2D manifold projection"></svg>
                        </div>
                        <div class="viz-panel">
                            <h3>3D Fiber Sketch</h3>
                            <canvas id="manifold-canvas" class="viz-canvas"></canvas>
                        </div>
                        <div class="viz-panel">
                            <h3>3D Field</h3>
                            <canvas id="manifold-field" class="viz-canvas"></canvas>
                        </div>
                        <div class="viz-panel">
                            <h3>3D Mesh</h3>
                            <canvas id="manifold-webgl" class="viz-canvas"></canvas>
                        </div>
                    </div>
                    <div class="modal-details">
                        <h3>Topological Profile</h3>
                        <div id="modal-details-content" class="details-grid"></div>
                    </div>
                    <div class="analysis-panel">
                        <div class="analysis-header">
                            <h3>On-Demand Analysis</h3>
                            <button id="run-analysis" class="btn btn-primary">Run Analysis</button>
                        </div>
                        <p id="analysis-status" class="note">Click “Run Analysis” to compute geometric indicators and export a report.</p>
                        <div id="analysis-results" class="details-grid"></div>
                        <a id="analysis-download" class="btn btn-secondary" style="display: none;">Download Analysis Bundle</a>
                    </div>
                    <div class="share-row">
                        <span class="share-label">Share</span>
                        <a id="share-link" class="share-pill" target="_blank" rel="noopener">Open full renderer</a>
                        <button class="share-icon" data-share="facebook" aria-label="Share on Facebook">
                            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12a10 10 0 1 0-11.6 9.9v-7H7.9v-2.9h2.5V9.7c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.4h-1.2c-1.2 0-1.6.8-1.6 1.5v1.8h2.8l-.4 2.9h-2.4v7A10 10 0 0 0 22 12z"/></svg>
                        </button>
                        <button class="share-icon" data-share="linkedin" aria-label="Share on LinkedIn">
                            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.4 20.4h-3.6v-5.6c0-1.3 0-3-1.8-3s-2.1 1.4-2.1 2.9v5.7H9.3V9h3.4v1.6h.1c.5-.9 1.7-1.8 3.5-1.8 3.7 0 4.4 2.5 4.4 5.7v6zM5.3 7.4a2.1 2.1 0 1 1 0-4.2 2.1 2.1 0 0 1 0 4.2zM7.1 20.4H3.5V9h3.6v11.4z"/></svg>
                        </button>
                        <button class="share-icon" data-share="x" aria-label="Share on X">
                            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17.5 3h3.2l-7 8 8.2 10h-6.4l-5-6.5-5.6 6.5H1.7l7.5-8.7L1 3h6.5l4.5 5.9L17.5 3zm-1.1 16h1.8L7.9 5h-2l10.5 14z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/js/geometries/ParametricGeometry.js"></script>
    <script>
    const datasetDescriptions = {
        'kreuzer-skarke': 'Searching for manifolds with |chi| < 100.',
        'cy5-folds': 'Searching for manifolds with h11 > 100 (large volume scenarios).',
        'heterotic': 'Searching for balanced manifolds with h11 ~= h21.'
    };

    const grid = document.getElementById('candidates-grid');
    const modal = document.getElementById('candidate-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const modalMeta = document.getElementById('modal-meta');
    const modalDetails = document.getElementById('modal-details-content');
    const svg = document.getElementById('manifold-svg');
    const canvas = document.getElementById('manifold-canvas');
    const fieldCanvas = document.getElementById('manifold-field');
    const webglCanvas = document.getElementById('manifold-webgl');
    let animationId = null;
    let fieldAnimationId = null;
    let webglAnimationId = null;
    let webglRenderer = null;
    let webglScene = null;
    let webglCamera = null;
    let webglMesh = null;
    let featuredTags = [];
    let selectedIds = new Set();

    function mulberry32(a) {
        return function() {
            let t = a += 0x6D2B79F5;
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
    }

    function getThemeColors() {
        const styles = getComputedStyle(document.documentElement);
        return {
            primary: styles.getPropertyValue('--primary-color').trim() || '#1a5490',
            secondary: styles.getPropertyValue('--secondary-color').trim() || '#4a7ba7',
            bg: styles.getPropertyValue('--bg-secondary').trim() || '#f4f6f8'
        };
    }

    function hexToRgb(hex) {
        const cleaned = hex.replace('#', '');
        if (cleaned.length !== 6) return { r: 26, g: 84, b: 144 };
        return {
            r: parseInt(cleaned.slice(0, 2), 16),
            g: parseInt(cleaned.slice(2, 4), 16),
            b: parseInt(cleaned.slice(4, 6), 16)
        };
    }

    function colorToRgba(hex, alpha) {
        const { r, g, b } = hexToRgb(hex);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function updateDescription() {
        const datasetId = document.getElementById('gallery-dataset').value;
        document.getElementById('gallery-description').textContent = datasetDescriptions[datasetId] || '';
    }

    function setLoading() {
        grid.innerHTML = '<div class="candidate-card candidate-card-loading">Loading candidates...</div>';
    }

    function renderCandidates(list) {
        if (!list.length) {
            grid.innerHTML = '<div class="candidate-card candidate-card-loading">No candidates available.</div>';
            return;
        }

        grid.innerHTML = list.map(candidate => {
            const featureTags = candidate.features.map(([label, value]) =>
                `<span class="pill">${label}: ${value}</span>`
            ).join('');
            const verifiedText = candidate.verified_target ? 'Verified' : 'Unverified';
            const selectedClass = selectedIds.has(candidate.candidate_id) ? 'selected' : '';
            return `
                <div class="candidate-card ${selectedClass}" data-id="${candidate.candidate_id}" data-dataset="${candidate.dataset_id}" data-seed="${candidate.viz_seed}" data-score="${candidate.score}" data-rank="${candidate.rank}" data-verified="${candidate.verified_target}" data-name="${candidate.dataset_name}">
                    <div class="candidate-rank">#${candidate.rank}</div>
                    <h3 class="candidate-title">${candidate.candidate_id}</h3>
                    <p class="candidate-meta">${candidate.dataset_name}</p>
                    <div class="candidate-score">Score: ${candidate.score.toFixed(4)}</div>
                    <div class="candidate-features">${featureTags}</div>
                    <div class="candidate-tag ${candidate.verified_target ? 'verified' : 'unverified'}">${verifiedText}</div>
                </div>
            `;
        }).join('');
    }

    function renderTags(tags) {
        const container = document.getElementById('tag-filters');
        if (!tags.length) {
            container.innerHTML = '';
            return;
        }
        container.innerHTML = `
            <span class="tag-label">Tags:</span>
            ${tags.map(tag => `<button class="tag-chip" data-tag="${tag}">${tag}</button>`).join('')}
        `;
    }

    async function loadCandidates() {
        setLoading();
        selectedIds.clear();
        updateSelectionUI();
        const view = document.getElementById('gallery-view').value;
        const datasetId = document.getElementById('gallery-dataset').value;
        const topN = document.getElementById('gallery-top-n').value;
        const seed = document.getElementById('gallery-seed').value;
        const verified = document.getElementById('gallery-verified').value;

        try {
            let endpoint = `/api/candidates?dataset_id=${datasetId}&top_n=${topN}&seed=${seed}`;
            if (view === 'featured') {
                endpoint = `/api/featured-candidates?dataset_id=${datasetId}`;
                if (verified !== 'all') {
                    endpoint += `&verified=${verified}`;
                }
            }
            const response = await fetch(endpoint);
            const data = await response.json();
            if (data.status !== 'success') {
                throw new Error(data.message || 'Failed to load candidates.');
            }
            const candidates = data.candidates || [];
            renderCandidates(candidates);

            if (view === 'featured') {
                featuredTags = [...new Set(candidates.flatMap(item => item.tags || []))].sort();
                renderTags(featuredTags);
            } else {
                renderTags([]);
            }
        } catch (error) {
            grid.innerHTML = `<div class="candidate-card candidate-card-loading">Error: ${error.message}</div>`;
        }
    }

    function renderSvg(detail) {
        const seed = detail.viz_seed || 42;
        const rand = mulberry32(seed);
        const colors = getThemeColors();
        const loops = 3 + Math.floor(rand() * 3);
        const amplitude = 60 + rand() * 40;
        const path = [];
        const centerX = 160;
        const centerY = 100;

        for (let i = 0; i <= 200; i++) {
            const t = (i / 200) * Math.PI * 2 * loops;
            const r = amplitude * (0.6 + 0.4 * Math.sin(t * 0.6 + rand()));
            const x = centerX + Math.cos(t) * r;
            const y = centerY + Math.sin(t * 1.2) * (r * 0.6);
            path.push(`${i === 0 ? 'M' : 'L'} ${x.toFixed(1)} ${y.toFixed(1)}`);
        }

        svg.innerHTML = `
            <defs>
                <linearGradient id="manifoldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="${colors.primary}"/>
                    <stop offset="100%" stop-color="${colors.secondary}"/>
                </linearGradient>
            </defs>
            <rect width="320" height="200" rx="16" fill="${colors.bg}"></rect>
            <path d="${path.join(' ')}" fill="none" stroke="url(#manifoldGradient)" stroke-width="3" stroke-linecap="round"></path>
        `;
    }

    function renderCanvas(detail) {
        if (animationId) {
            cancelAnimationFrame(animationId);
        }

        const ctx = canvas.getContext('2d');
        const seed = detail.viz_seed || 42;
        const rand = mulberry32(seed);
        const colors = getThemeColors();
        const width = canvas.clientWidth || 320;
        const height = canvas.clientHeight || 200;
        canvas.width = width;
        canvas.height = height;

        const pointCount = 240;
        const baseRadius = 40 + rand() * 30;
        const points = Array.from({ length: pointCount }, () => {
            const theta = rand() * Math.PI * 2;
            const phi = rand() * Math.PI * 2;
            const radius = baseRadius + rand() * 30;
            return {
                x: radius * Math.cos(theta) * Math.sin(phi),
                y: radius * Math.sin(theta) * Math.sin(phi),
                z: radius * Math.cos(phi)
            };
        });

        let angle = 0;
        const draw = () => {
            ctx.clearRect(0, 0, width, height);
            const bgGrad = ctx.createLinearGradient(0, 0, width, height);
            bgGrad.addColorStop(0, colors.bg);
            bgGrad.addColorStop(1, colorToRgba(colors.secondary, 0.08));
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, width, height);

            const cx = width / 2;
            const cy = height / 2;
            const scale = 1.2;
            const cosA = Math.cos(angle);
            const sinA = Math.sin(angle);

            points.forEach(point => {
                const x = point.x * cosA - point.z * sinA;
                const z = point.x * sinA + point.z * cosA;
                const y = point.y * Math.cos(angle * 0.7) - z * Math.sin(angle * 0.7);
                const depth = (z + 120) / 240;
                const px = cx + x * scale;
                const py = cy + y * scale;
                ctx.beginPath();
                ctx.arc(px, py, 1.2 + depth * 1.8, 0, Math.PI * 2);
                ctx.fillStyle = colorToRgba(colors.secondary, 0.28 + depth * 0.5);
                ctx.fill();
            });

            angle += 0.01;
            animationId = requestAnimationFrame(draw);
        };

        draw();
    }

    function renderFieldCanvas(detail) {
        if (fieldAnimationId) {
            cancelAnimationFrame(fieldAnimationId);
        }

        const ctx = fieldCanvas.getContext('2d');
        const seed = detail.viz_seed || 42;
        const rand = mulberry32(seed + 99);
        const colors = getThemeColors();
        const width = fieldCanvas.clientWidth || 320;
        const height = fieldCanvas.clientHeight || 200;
        fieldCanvas.width = width;
        fieldCanvas.height = height;

        const ribbons = Array.from({ length: 6 }, () => ({
            offset: rand() * Math.PI * 2,
            speed: 0.4 + rand() * 0.6,
            amplitude: 20 + rand() * 25
        }));

        let t = 0;
        const draw = () => {
            ctx.clearRect(0, 0, width, height);
            const bgGrad = ctx.createLinearGradient(0, 0, width, height);
            bgGrad.addColorStop(0, colors.bg);
            bgGrad.addColorStop(1, colorToRgba(colors.primary, 0.08));
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, width, height);

            ribbons.forEach((ribbon, idx) => {
                ctx.beginPath();
                for (let x = 0; x <= width; x += 6) {
                    const phase = ribbon.offset + t * ribbon.speed + x * 0.01;
                    const y = height / 2 + Math.sin(phase) * ribbon.amplitude + Math.sin(phase * 0.7) * 12;
                    if (x === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                const alpha = 0.22 + idx * 0.1;
                ctx.strokeStyle = colorToRgba(colors.primary, alpha);
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            t += 0.02;
            fieldAnimationId = requestAnimationFrame(draw);
        };

        draw();
    }

    function createParametricGeometry(seed) {
        const rand = mulberry32(seed + 777);
        const a = 1.2 + rand() * 0.4;
        const b = 0.7 + rand() * 0.3;
        const c = 0.6 + rand() * 0.3;

        const surface = (u, v, target) => {
            const U = u * Math.PI * 2;
            const V = v * Math.PI * 2;

            const r = 1 + 0.35 * Math.cos(3 * U) * Math.sin(2 * V);
            const x = (a * Math.cos(U) + b * Math.cos(2 * U)) * r;
            const y = (a * Math.sin(U) - b * Math.sin(2 * U)) * r;
            const z = c * Math.sin(3 * V) + 0.25 * Math.sin(U + V);

            target.set(x, y, z);
        };

        if (typeof THREE.ParametricGeometry !== 'undefined') {
            return new THREE.ParametricGeometry(surface, 140, 80);
        }
        return null;
    }

    function renderWebGL(detail) {
        if (!window.THREE || !webglCanvas) return;
        if (webglAnimationId) {
            cancelAnimationFrame(webglAnimationId);
        }

        const colors = getThemeColors();
        const width = webglCanvas.clientWidth || 320;
        const height = webglCanvas.clientHeight || 200;

        webglRenderer = new THREE.WebGLRenderer({
            canvas: webglCanvas,
            antialias: true,
            alpha: true
        });
        webglRenderer.setSize(width, height, false);
        webglRenderer.setPixelRatio(window.devicePixelRatio || 1);
        webglRenderer.setClearColor(0x000000, 0);

        webglScene = new THREE.Scene();
        webglCamera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
        webglCamera.position.set(0, 0, 6);

        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        webglScene.add(ambient);

        const keyLight = new THREE.DirectionalLight(0xffffff, 0.9);
        keyLight.position.set(3, 4, 6);
        webglScene.add(keyLight);

        const fillLight = new THREE.PointLight(0x6db7ff, 0.6);
        fillLight.position.set(-4, -2, 4);
        webglScene.add(fillLight);

        const geometry = createParametricGeometry(detail.viz_seed || 42) ||
            new THREE.TorusKnotGeometry(1.4, 0.48, 160, 32, 2, 3);
        const material = new THREE.MeshStandardMaterial({
            color: colors.primary,
            metalness: 0.6,
            roughness: 0.25,
            emissive: new THREE.Color(colors.secondary),
            emissiveIntensity: 0.2
        });

        webglMesh = new THREE.Mesh(geometry, material);
        webglScene.add(webglMesh);

        const animate = () => {
            webglMesh.rotation.x += 0.007;
            webglMesh.rotation.y += 0.01;
            webglMesh.rotation.z += 0.004;
            webglRenderer.render(webglScene, webglCamera);
            webglAnimationId = requestAnimationFrame(animate);
        };

        animate();
    }

    function openModal(candidate) {
        modal.style.display = 'flex';
        modalTitle.textContent = candidate.candidate_id;
        modalSubtitle.textContent = candidate.dataset_name;
        modalMeta.innerHTML = `
            <span class="pill">Rank #${candidate.rank}</span>
            <span class="pill">Score ${candidate.score.toFixed(4)}</span>
            <span class="pill ${candidate.verified_target ? 'pill-verified' : 'pill-unverified'}">
                ${candidate.verified_target ? 'Verified' : 'Unverified'}
            </span>
        `;
        renderSvg(candidate);
        renderCanvas(candidate);
        renderFieldCanvas(candidate);
        renderWebGL(candidate);
        modalDetails.innerHTML = '';
        document.getElementById('analysis-status').textContent = '';
        document.getElementById('analysis-results').innerHTML = '';
        document.getElementById('analysis-download').style.display = 'none';

        const renderUrl = `${window.location.origin}/render.html?candidate_id=${candidate.candidate_id}&dataset_id=${candidate.dataset_id}&seed=${candidate.viz_seed}`;
        const shareLink = document.getElementById('share-link');
        if (shareLink) {
            shareLink.href = renderUrl;
        }

        modal.querySelectorAll('.share-icon').forEach(button => {
            button.onclick = () => {
                const encoded = encodeURIComponent(renderUrl);
                let shareUrl = renderUrl;
                if (button.dataset.share === 'facebook') {
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encoded}`;
                } else if (button.dataset.share === 'linkedin') {
                    shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encoded}`;
                } else if (button.dataset.share === 'x') {
                    shareUrl = `https://twitter.com/intent/tweet?url=${encoded}`;
                }
                window.open(shareUrl, '_blank', 'noopener,noreferrer');
            };
        });

        document.getElementById('run-analysis').onclick = async () => {
            const status = document.getElementById('analysis-status');
            const results = document.getElementById('analysis-results');
            const download = document.getElementById('analysis-download');
            status.textContent = 'Running analysis...';
            results.innerHTML = '';
            download.style.display = 'none';

            const response = await fetch('/api/analyze-candidate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    candidate_id: candidate.candidate_id,
                    dataset_id: candidate.dataset_id,
                    seed: candidate.viz_seed,
                    top_n: document.getElementById('gallery-top-n').value,
                    source: document.getElementById('gallery-view').value
                })
            });

            const data = await response.json();
            if (data.status !== 'success') {
                status.textContent = data.error || 'Analysis failed.';
                return;
            }

            const analysis = data.analysis;
            status.textContent = analysis.summary || 'Analysis complete.';
            const blocks = [
                ['Complexity index', analysis.complexity_index],
                ['Stability score', analysis.stability_score],
                ['h11/h21 ratio', analysis.derived_metrics?.h11_h21_ratio],
                ['h21/h11 ratio', analysis.derived_metrics?.h21_h11_ratio],
                ['|Euler|', analysis.derived_metrics?.euler_abs]
            ];
            results.innerHTML = blocks.map(([label, value]) => `
                <div class="detail-item">
                    <span>${label}</span>
                    <strong>${value !== null && value !== undefined ? value : 'N/A'}</strong>
                </div>
            `).join('');

            download.href = `/api/analysis/${candidate.candidate_id}/bundle`;
            download.style.display = 'inline-block';
        };

        fetch(`/api/candidate/${candidate.candidate_id}?dataset_id=${candidate.dataset_id}`)
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    throw new Error(data.message || 'Unable to load candidate details.');
                }
                const detail = data.candidate;
                const features = detail.features || [];
                const invariants = detail.invariants || [];
                const blocks = [
                    ...features.map(([label, value]) => ({ label, value })),
                    ...invariants
                ];
                modalDetails.innerHTML = blocks.map(item => `
                    <div class="detail-item">
                        <span>${item.label}</span>
                        <strong>${item.value}</strong>
                    </div>
                `).join('');
            })
            .catch(error => {
                modalDetails.innerHTML = `<p class="note">Details unavailable: ${error.message}</p>`;
            });
    }

    function closeModal() {
        modal.style.display = 'none';
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (fieldAnimationId) {
            cancelAnimationFrame(fieldAnimationId);
            fieldAnimationId = null;
        }
        if (webglAnimationId) {
            cancelAnimationFrame(webglAnimationId);
            webglAnimationId = null;
        }
        if (webglRenderer) {
            webglRenderer.dispose();
            webglRenderer = null;
        }
    }

    document.getElementById('gallery-refresh').addEventListener('click', loadCandidates);
    document.getElementById('gallery-dataset').addEventListener('change', () => {
        updateDescription();
        loadCandidates();
    });
    document.getElementById('gallery-view').addEventListener('change', () => {
        loadCandidates();
    });
    document.getElementById('gallery-verified').addEventListener('change', () => {
        loadCandidates();
    });

    grid.addEventListener('click', event => {
        const card = event.target.closest('.candidate-card');
        if (!card || card.classList.contains('candidate-card-loading')) return;
        if (document.getElementById('select-mode').checked) {
            const id = card.dataset.id;
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
                card.classList.remove('selected');
            } else {
                selectedIds.add(id);
                card.classList.add('selected');
            }
            updateSelectionUI();
            return;
        }

        openModal({
            candidate_id: card.dataset.id,
            dataset_id: card.dataset.dataset,
            rank: Number(card.dataset.rank),
            score: Number(card.dataset.score),
            verified_target: card.dataset.verified === 'true',
            dataset_name: card.dataset.name,
            viz_seed: Number(card.dataset.seed)
        });
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    modal.addEventListener('click', event => {
        if (event.target === modal) closeModal();
    });

    document.getElementById('tag-filters').addEventListener('click', event => {
        const chip = event.target.closest('.tag-chip');
        if (!chip) return;
        if (document.getElementById('gallery-view').value !== 'featured') return;
        document.querySelectorAll('.tag-chip').forEach(item => {
            if (item !== chip) item.classList.remove('active');
        });
        const selected = chip.classList.toggle('active');
        if (!selected) {
            loadCandidates();
            return;
        }
        const tag = chip.dataset.tag;
        setLoading();
        const datasetId = document.getElementById('gallery-dataset').value;
        const verified = document.getElementById('gallery-verified').value;
        let endpoint = `/api/featured-candidates?dataset_id=${datasetId}&tag=${tag}`;
        if (verified !== 'all') {
            endpoint += `&verified=${verified}`;
        }
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    throw new Error(data.message || 'Failed to filter candidates.');
                }
                renderCandidates(data.candidates || []);
            })
            .catch(error => {
                grid.innerHTML = `<div class="candidate-card candidate-card-loading">Error: ${error.message}</div>`;
            });
    });

    updateDescription();
    loadCandidates();

    function updateSelectionUI() {
        const count = selectedIds.size;
        const exportBtn = document.getElementById('gallery-export');
        exportBtn.disabled = count === 0;
        document.getElementById('selection-count').textContent = count ? `Selected: ${count}` : '';
    }

    document.getElementById('select-mode').addEventListener('change', function() {
        selectedIds.clear();
        document.querySelectorAll('.candidate-card.selected').forEach(card => card.classList.remove('selected'));
        updateSelectionUI();
    });

    document.getElementById('gallery-export').addEventListener('click', async function() {
        if (!selectedIds.size) return;
        const view = document.getElementById('gallery-view').value;
        const datasetId = document.getElementById('gallery-dataset').value;
        const seed = document.getElementById('gallery-seed').value;
        const topN = document.getElementById('gallery-top-n').value;

        const response = await fetch('/api/export-gallery', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                source: view,
                dataset_id: datasetId,
                seed: seed,
                top_n: topN,
                candidate_ids: Array.from(selectedIds)
            })
        });

        if (!response.ok) return;
        const blob = await response.blob();
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'gallery_selection.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    });
    </script>
{% endblock %}
