{% extends "base.html" %}
{% set active_page = "" %}

{% block title %}3D Renderer - upg-strings{% endblock %}
{% block description %}Interactive 3D renderer for Calabi-Yau candidates.{% endblock %}
{% block og_tags %}
    <meta property="og:title" content="{{ og_title }}">
    <meta property="og:description" content="{{ og_description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_url }}">
    <meta property="og:image" content="{{ og_image }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{{ og_title }}">
    <meta property="og:site_name" content="upg-strings">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ og_title }}">
    <meta name="twitter:description" content="{{ og_description }}">
    <meta name="twitter:image" content="{{ og_image }}">
{% endblock %}

{% block content %}
    <main class="container">
        <section class="section">
            <h1>Interactive 3D Renderer</h1>
            <p id="render-subtitle" class="note"></p>
            <div class="details-grid" id="render-details">
                <div class="detail-item">
                    <span>Candidate</span>
                    <strong id="render-candidate">-</strong>
                </div>
                <div class="detail-item">
                    <span>Dataset</span>
                    <strong id="render-dataset">-</strong>
                </div>
                <div class="detail-item">
                    <span>Seed</span>
                    <strong id="render-seed">-</strong>
                </div>
                <div class="detail-item">
                    <span>h11</span>
                    <strong id="render-h11">-</strong>
                </div>
                <div class="detail-item">
                    <span>h21</span>
                    <strong id="render-h21">-</strong>
                </div>
                <div class="detail-item">
                    <span>χ</span>
                    <strong id="render-chi">-</strong>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="renderer-shell">
                <canvas id="render-canvas" class="renderer-canvas"></canvas>
            </div>
            <div class="analysis-panel">
                <div class="analysis-header">
                    <h2>On-Demand Analysis</h2>
                    <button id="render-analysis" class="btn btn-primary">Run Analysis</button>
                </div>
                <p id="render-analysis-status" class="note">Click “Run Analysis” to compute geometric indicators and export a report.</p>
                <div id="render-analysis-results" class="details-grid"></div>
                <a id="render-analysis-download" class="btn btn-secondary" style="display: none;">Download Analysis Bundle</a>
            </div>
            <div class="share-row">
                <span class="share-label">Share</span>
                <button class="share-icon" data-share="facebook" aria-label="Share on Facebook">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12a10 10 0 1 0-11.6 9.9v-7H7.9v-2.9h2.5V9.7c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.4h-1.2c-1.2 0-1.6.8-1.6 1.5v1.8h2.8l-.4 2.9h-2.4v7A10 10 0 0 0 22 12z"/></svg>
                </button>
                <button class="share-icon" data-share="linkedin" aria-label="Share on LinkedIn">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.4 20.4h-3.6v-5.6c0-1.3 0-3-1.8-3s-2.1 1.4-2.1 2.9v5.7H9.3V9h3.4v1.6h.1c.5-.9 1.7-1.8 3.5-1.8 3.7 0 4.4 2.5 4.4 5.7v6zM5.3 7.4a2.1 2.1 0 1 1 0-4.2 2.1 2.1 0 0 1 0 4.2zM7.1 20.4H3.5V9h3.6v11.4z"/></svg>
                </button>
                <button class="share-icon" data-share="x" aria-label="Share on X">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17.5 3h3.2l-7 8 8.2 10h-6.4l-5-6.5-5.6 6.5H1.7l7.5-8.7L1 3h6.5l4.5 5.9L17.5 3zm-1.1 16h1.8L7.9 5h-2l10.5 14z"/></svg>
                </button>
            </div>
        </section>
    </main>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/js/geometries/ParametricGeometry.js"></script>
    <script>
    const canvas = document.getElementById('render-canvas');
    const subtitle = document.getElementById('render-subtitle');
    const urlParams = new URLSearchParams(window.location.search);
    const seedParam = parseInt(urlParams.get('seed') || '4242', 10);
    const candidateId = urlParams.get('candidate_id');
    const datasetId = urlParams.get('dataset_id');

    subtitle.textContent = candidateId ? `${candidateId} (${datasetId || 'unknown dataset'})` : 'Interactive render preview.';
    document.getElementById('render-candidate').textContent = candidateId || 'Sample candidate';
    document.getElementById('render-dataset').textContent = datasetId || 'Not specified';
    document.getElementById('render-seed').textContent = seedParam;
    document.getElementById('render-h11').textContent = urlParams.get('h11') || 'N/A';
    document.getElementById('render-h21').textContent = urlParams.get('h21') || 'N/A';
    document.getElementById('render-chi').textContent = urlParams.get('chi') || 'N/A';

    document.getElementById('render-analysis').addEventListener('click', async () => {
        const status = document.getElementById('render-analysis-status');
        const results = document.getElementById('render-analysis-results');
        const download = document.getElementById('render-analysis-download');
        status.textContent = 'Running analysis...';
        results.innerHTML = '';
        download.style.display = 'none';

        if (!candidateId) {
            status.textContent = 'Candidate not specified.';
            return;
        }

        const response = await fetch('/api/analyze-candidate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                candidate_id: candidateId,
                dataset_id: datasetId,
                seed: seedParam,
                source: 'featured'
            })
        });

        const data = await response.json();
        if (data.status !== 'success') {
            status.textContent = data.error || 'Analysis failed.';
            return;
        }

        const analysis = data.analysis;
        status.textContent = analysis.summary || 'Analysis complete.';
        const blocks = [
            ['Complexity index', analysis.complexity_index],
            ['Stability score', analysis.stability_score],
            ['h11/h21 ratio', analysis.derived_metrics?.h11_h21_ratio],
            ['h21/h11 ratio', analysis.derived_metrics?.h21_h11_ratio],
            ['|Euler|', analysis.derived_metrics?.euler_abs]
        ];
        results.innerHTML = blocks.map(([label, value]) => `
            <div class="detail-item">
                <span>${label}</span>
                <strong>${value !== null && value !== undefined ? value : 'N/A'}</strong>
            </div>
        `).join('');

        download.href = `/api/analysis/${candidateId}/bundle`;
        download.style.display = 'inline-block';
    });

    function getThemeColors() {
        const styles = getComputedStyle(document.documentElement);
        return {
            primary: styles.getPropertyValue('--primary-color').trim() || '#1a5490',
            secondary: styles.getPropertyValue('--secondary-color').trim() || '#4a7ba7',
            bg: styles.getPropertyValue('--bg-secondary').trim() || '#f4f6f8'
        };
    }

    function applyVertexColors(geometry, seed) {
        const rand = (() => {
            let a = seed + 91;
            return () => {
                let t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            };
        })();
        const color = new THREE.Color();
        const position = geometry.attributes.position;
        const colors = [];
        const baseHue = rand();

        for (let i = 0; i < position.count; i++) {
            const x = position.getX(i);
            const y = position.getY(i);
            const z = position.getZ(i);
            const hue = (baseHue + (Math.atan2(y, x) / (Math.PI * 2)) + 0.5) % 1;
            const light = 0.45 + 0.2 * Math.sin(z * 0.9);
            color.setHSL(hue, 0.7, light);
            colors.push(color.r, color.g, color.b);
        }

        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        return geometry;
    }

    function createParametricGeometry(seed, params) {
        const rand = (() => {
            let a = seed + 777;
            return () => {
                let t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            };
        })();
        const a = params.a ?? (1.1 + rand() * 0.6);
        const b = params.b ?? (0.5 + rand() * 0.6);
        const c = params.c ?? (0.4 + rand() * 0.6);
        const f1 = params.f1 ?? (2 + Math.floor(rand() * 4));
        const f2 = params.f2 ?? (2 + Math.floor(rand() * 5));
        const f3 = params.f3 ?? (3 + Math.floor(rand() * 4));
        const f4 = params.f4 ?? (2 + Math.floor(rand() * 6));
        const f5 = params.f5 ?? (3 + Math.floor(rand() * 5));
        const warp = params.warp ?? (0.2 + rand() * 0.4);
        const twist = params.twist ?? (0.15 + rand() * 0.35);

        const surface = (u, v, target) => {
            const U = u * Math.PI * 2;
            const V = v * Math.PI * 2;
            const r = 1
                + warp * Math.cos(f1 * U) * Math.sin(f2 * V)
                + 0.18 * Math.sin(f3 * (U + V));
            const x = (a * Math.cos(U) + b * Math.cos(f1 * U)) * r;
            const y = (a * Math.sin(U) - b * Math.sin(f2 * U)) * r;
            const z = c * Math.sin(f3 * V) + twist * Math.sin(f4 * U - f5 * V);
            target.set(x, y, z);
        };

        if (typeof THREE.ParametricGeometry !== 'undefined') {
            const geometry = new THREE.ParametricGeometry(surface, 200, 100);
            return applyVertexColors(geometry, seed);
        }
        return null;
    }

    function renderMesh(seed) {
        if (!window.THREE) return;
        const colors = getThemeColors();
        const width = canvas.clientWidth || 900;
        const height = canvas.clientHeight || 500;

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(width, height, false);
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        renderer.setClearColor(0x000000, 0);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
        camera.position.set(0, 0, 7);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const keyLight = new THREE.DirectionalLight(0xffffff, 0.9);
        keyLight.position.set(4, 6, 8);
        scene.add(keyLight);
        const rimLight = new THREE.PointLight(0x6db7ff, 0.8);
        rimLight.position.set(-5, -3, 4);
        scene.add(rimLight);

        const seedRand = (() => {
            let a = seed + 31;
            return () => {
                let t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            };
        })();
        const shapeParams = (() => {
            const h11 = Number(urlParams.get('h11') || 10);
            const h21 = Number(urlParams.get('h21') || 12);
            const chi = Number(urlParams.get('chi') || 0);
            return {
                a: 1.0 + (h11 % 7) * 0.06,
                b: 0.5 + (h21 % 9) * 0.05,
                c: 0.35 + (Math.abs(chi) % 11) * 0.03,
                f1: 2 + (h11 % 5),
                f2: 2 + (h21 % 6),
                f3: 3 + (Math.abs(chi) % 4),
                f4: 2 + ((h11 + h21) % 6),
                f5: 3 + ((h11 + Math.abs(chi)) % 5),
                warp: 0.22 + ((h11 % 10) / 50),
                twist: 0.18 + ((h21 % 10) / 50)
            };
        })();
        const geometry = createParametricGeometry(seed, shapeParams) ||
            applyVertexColors(new THREE.TorusKnotGeometry(1.7, 0.55, 200, 40, 2, 3), seed);
        const meshColor = new THREE.Color().setHSL(seedRand(), 0.65, 0.52);
        const material = new THREE.MeshStandardMaterial({
            color: meshColor,
            vertexColors: true,
            metalness: 0.7,
            roughness: 0.22,
            emissive: new THREE.Color(colors.secondary),
            emissiveIntensity: 0.25
        });
        const mesh = new THREE.Mesh(geometry, material);
        const scale = 0.9 + seedRand() * 0.25;
        mesh.scale.set(scale, scale, scale);
        mesh.rotation.set(seedRand() * Math.PI, seedRand() * Math.PI, seedRand() * Math.PI);
        scene.add(mesh);

        let t = 0;
        const animate = () => {
            t += 0.006;
            mesh.rotation.x += 0.004;
            mesh.rotation.y += 0.007;
            mesh.rotation.z += 0.003;
            mesh.position.y = Math.sin(t) * 0.05;
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        };

        animate();
    }

    renderMesh(seedParam);

    document.querySelectorAll('.share-icon').forEach(button => {
        button.addEventListener('click', () => {
            const encoded = encodeURIComponent(window.location.href);
            let shareUrl = window.location.href;
            if (button.dataset.share === 'facebook') {
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encoded}`;
            } else if (button.dataset.share === 'linkedin') {
                shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encoded}`;
            } else if (button.dataset.share === 'x') {
                shareUrl = `https://twitter.com/intent/tweet?url=${encoded}`;
            }
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
        });
    });
    </script>
{% endblock %}
