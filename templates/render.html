{% extends "base.html" %}
{% set active_page = "" %}

{% block title %}3D Renderer - upg-strings{% endblock %}
{% block description %}Interactive 3D renderer for Calabi-Yau candidates.{% endblock %}
{% block og_tags %}
    <meta property="og:title" content="{{ og_title }}">
    <meta property="og:description" content="{{ og_description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_url }}">
    <meta property="og:image" content="{{ og_image }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{{ og_title }}">
    <meta property="og:site_name" content="upg-strings">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ og_title }}">
    <meta name="twitter:description" content="{{ og_description }}">
    <meta name="twitter:image" content="{{ og_image }}">
{% endblock %}

{% block content %}
    <main class="container">
        <section class="section">
            <h1>Interactive 3D Renderer</h1>
            <p id="render-subtitle" class="note"></p>
            <div class="details-grid" id="render-details">
                <div class="detail-item">
                    <span>Candidate</span>
                    <strong id="render-candidate">-</strong>
                </div>
                <div class="detail-item">
                    <span>Dataset</span>
                    <strong id="render-dataset">-</strong>
                </div>
                <div class="detail-item">
                    <span>Seed</span>
                    <strong id="render-seed">-</strong>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="renderer-shell">
                <canvas id="render-canvas" class="renderer-canvas"></canvas>
            </div>
            <div class="share-row">
                <span class="share-label">Share</span>
                <button class="share-icon" data-share="facebook" aria-label="Share on Facebook">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12a10 10 0 1 0-11.6 9.9v-7H7.9v-2.9h2.5V9.7c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.4h-1.2c-1.2 0-1.6.8-1.6 1.5v1.8h2.8l-.4 2.9h-2.4v7A10 10 0 0 0 22 12z"/></svg>
                </button>
                <button class="share-icon" data-share="linkedin" aria-label="Share on LinkedIn">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20.4 20.4h-3.6v-5.6c0-1.3 0-3-1.8-3s-2.1 1.4-2.1 2.9v5.7H9.3V9h3.4v1.6h.1c.5-.9 1.7-1.8 3.5-1.8 3.7 0 4.4 2.5 4.4 5.7v6zM5.3 7.4a2.1 2.1 0 1 1 0-4.2 2.1 2.1 0 0 1 0 4.2zM7.1 20.4H3.5V9h3.6v11.4z"/></svg>
                </button>
                <button class="share-icon" data-share="x" aria-label="Share on X">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17.5 3h3.2l-7 8 8.2 10h-6.4l-5-6.5-5.6 6.5H1.7l7.5-8.7L1 3h6.5l4.5 5.9L17.5 3zm-1.1 16h1.8L7.9 5h-2l10.5 14z"/></svg>
                </button>
            </div>
        </section>
    </main>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/js/geometries/ParametricGeometry.js"></script>
    <script>
    const canvas = document.getElementById('render-canvas');
    const subtitle = document.getElementById('render-subtitle');
    const params = new URLSearchParams(window.location.search);
    const seedParam = parseInt(params.get('seed') || '4242', 10);
    const candidateId = params.get('candidate_id');
    const datasetId = params.get('dataset_id');

    subtitle.textContent = candidateId ? `${candidateId} (${datasetId || 'unknown dataset'})` : 'Interactive render preview.';
    document.getElementById('render-candidate').textContent = candidateId || 'Sample candidate';
    document.getElementById('render-dataset').textContent = datasetId || 'Not specified';
    document.getElementById('render-seed').textContent = seedParam;

    function getThemeColors() {
        const styles = getComputedStyle(document.documentElement);
        return {
            primary: styles.getPropertyValue('--primary-color').trim() || '#1a5490',
            secondary: styles.getPropertyValue('--secondary-color').trim() || '#4a7ba7',
            bg: styles.getPropertyValue('--bg-secondary').trim() || '#f4f6f8'
        };
    }

    function createParametricGeometry(seed) {
        const rand = (() => {
            let a = seed + 777;
            return () => {
                let t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            };
        })();
        const a = 1.2 + rand() * 0.4;
        const b = 0.7 + rand() * 0.3;
        const c = 0.6 + rand() * 0.3;

        const surface = (u, v, target) => {
            const U = u * Math.PI * 2;
            const V = v * Math.PI * 2;
            const r = 1 + 0.35 * Math.cos(3 * U) * Math.sin(2 * V);
            const x = (a * Math.cos(U) + b * Math.cos(2 * U)) * r;
            const y = (a * Math.sin(U) - b * Math.sin(2 * U)) * r;
            const z = c * Math.sin(3 * V) + 0.25 * Math.sin(U + V);
            target.set(x, y, z);
        };

        return new THREE.ParametricGeometry(surface, 200, 100);
    }

    function renderMesh(seed) {
        if (!window.THREE) return;
        const colors = getThemeColors();
        const width = canvas.clientWidth || 900;
        const height = canvas.clientHeight || 500;

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(width, height, false);
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        renderer.setClearColor(0x000000, 0);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
        camera.position.set(0, 0, 7);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const keyLight = new THREE.DirectionalLight(0xffffff, 0.9);
        keyLight.position.set(4, 6, 8);
        scene.add(keyLight);
        const rimLight = new THREE.PointLight(0x6db7ff, 0.8);
        rimLight.position.set(-5, -3, 4);
        scene.add(rimLight);

        const geometry = createParametricGeometry(seed);
        const material = new THREE.MeshStandardMaterial({
            color: colors.primary,
            metalness: 0.7,
            roughness: 0.22,
            emissive: new THREE.Color(colors.secondary),
            emissiveIntensity: 0.25
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.rotation.set(0.4, 0.3, 0);
        scene.add(mesh);

        let t = 0;
        const animate = () => {
            t += 0.006;
            mesh.rotation.x += 0.004;
            mesh.rotation.y += 0.007;
            mesh.rotation.z += 0.003;
            mesh.position.y = Math.sin(t) * 0.05;
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        };

        animate();
    }

    renderMesh(seedParam);

    document.querySelectorAll('.share-icon').forEach(button => {
        button.addEventListener('click', () => {
            const encoded = encodeURIComponent(window.location.href);
            let shareUrl = window.location.href;
            if (button.dataset.share === 'facebook') {
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encoded}`;
            } else if (button.dataset.share === 'linkedin') {
                shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encoded}`;
            } else if (button.dataset.share === 'x') {
                shareUrl = `https://twitter.com/intent/tweet?url=${encoded}`;
            }
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
        });
    });
    </script>
{% endblock %}
