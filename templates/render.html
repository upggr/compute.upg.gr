{% extends "base.html" %}
{% set active_page = "" %}

{% block title %}3D Renderer - upg-strings{% endblock %}
{% block description %}Interactive 3D renderer for Calabi-Yau candidates.{% endblock %}
{% block og_tags %}
    <meta property="og:title" content="3D Renderer - upg-strings">
    <meta property="og:description" content="Interactive 3D renderer for Calabi-Yau candidates.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://compute.upg.gr/render.html">
{% endblock %}

{% block content %}
    <main class="container">
        <section class="section">
            <h1>Interactive 3D Renderer</h1>
            <p id="render-subtitle" class="note"></p>
        </section>

        <section class="section">
            <div class="renderer-shell">
                <canvas id="render-canvas" class="renderer-canvas"></canvas>
            </div>
            <div class="share-row">
                <span class="share-label">Share</span>
                <button class="share-icon" data-share="facebook" aria-label="Share on Facebook">f</button>
                <button class="share-icon" data-share="linkedin" aria-label="Share on LinkedIn">in</button>
                <button class="share-icon" data-share="x" aria-label="Share on X">x</button>
            </div>
        </section>
    </main>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script>
    const canvas = document.getElementById('render-canvas');
    const subtitle = document.getElementById('render-subtitle');
    const params = new URLSearchParams(window.location.search);
    const seedParam = parseInt(params.get('seed') || '4242', 10);
    const candidateId = params.get('candidate_id');
    const datasetId = params.get('dataset_id');

    subtitle.textContent = candidateId ? `${candidateId} (${datasetId || 'unknown dataset'})` : 'Preview of a Calabi-Yau inspired surface.';

    function getThemeColors() {
        const styles = getComputedStyle(document.documentElement);
        return {
            primary: styles.getPropertyValue('--primary-color').trim() || '#1a5490',
            secondary: styles.getPropertyValue('--secondary-color').trim() || '#4a7ba7',
            bg: styles.getPropertyValue('--bg-secondary').trim() || '#f4f6f8'
        };
    }

    function renderMesh(seed) {
        if (!window.THREE) return;
        const colors = getThemeColors();
        const width = canvas.clientWidth || 900;
        const height = canvas.clientHeight || 500;

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(width, height, false);
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        renderer.setClearColor(0x000000, 0);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
        camera.position.set(0, 0, 7);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const keyLight = new THREE.DirectionalLight(0xffffff, 0.9);
        keyLight.position.set(4, 6, 8);
        scene.add(keyLight);
        const rimLight = new THREE.PointLight(0x6db7ff, 0.8);
        rimLight.position.set(-5, -3, 4);
        scene.add(rimLight);

        const geometry = new THREE.TorusKnotGeometry(1.7, 0.55, 200, 40, 2, 3);
        const material = new THREE.MeshStandardMaterial({
            color: colors.primary,
            metalness: 0.7,
            roughness: 0.22,
            emissive: new THREE.Color(colors.secondary),
            emissiveIntensity: 0.25
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.rotation.set(0.4, 0.3, 0);
        scene.add(mesh);

        let t = 0;
        const animate = () => {
            t += 0.006;
            mesh.rotation.x += 0.004;
            mesh.rotation.y += 0.007;
            mesh.rotation.z += 0.003;
            mesh.position.y = Math.sin(t) * 0.05;
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        };

        animate();
    }

    renderMesh(seedParam);

    document.querySelectorAll('.share-icon').forEach(button => {
        button.addEventListener('click', () => {
            const encoded = encodeURIComponent(window.location.href);
            let shareUrl = window.location.href;
            if (button.dataset.share === 'facebook') {
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encoded}`;
            } else if (button.dataset.share === 'linkedin') {
                shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encoded}`;
            } else if (button.dataset.share === 'x') {
                shareUrl = `https://twitter.com/intent/tweet?url=${encoded}`;
            }
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
        });
    });
    </script>
{% endblock %}
